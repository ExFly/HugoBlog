---
title: "First_month_of_my_career"
author: "Author Name"
cover: "/img/cover.jpg"
tags: ["tagA", "tagB"]
date: 2018-08-30T16:48:37+08:00
draft: true
---

工作一段时间了，想总结一下最近所做、所想。内容有一点多，如果拆成几篇，可能我就没心思维护了，还是写到一起，一点一点的补充。之后会持续更新。

<!--more-->

# 技术

## 测试
最近一段时间，我花了大量的时间在测试上。为什么？因为在工作中，你会发现当你实现一个功能后，需要自己去验证，反反复复的去验证。尤其在项目初期，在不断试错的过程中，经常面临重构的情况。验证代码正确所花费的时间，完全是在浪费时间。很多时候通过设计完善的单元测试很大程度可以减少这种时间浪费的发生。

在做测试的时候，也是需要衡量各种方式，找到成本与效率之间的平衡。可以查到的资料就不再这里罗列的。说一下现阶段我们正在做的东西。或者说我在做的东西。我会把我为什么如何做进行一定的解释。

首先，对于工具函数，一定要进行单元测试，无可厚非

其次，对于数据库和依赖运行上下文的部分，没有使用mock，而是使用真实数据库，加测试服务（go httptest）

首先要说一下我们的项目。没有使用restful+mysql+java的组合，而是使用GraphQL+mongo+go的组合。之后我会以这个技术选型进行解释。

测试使用很有趣的地方要说Api对应的Handler。对他们来说，会牵扯到一些方法需要获取当前执行上下文中的信息。比如，一些Handler需要获得Application中的全局配置。初次之外数据库需要查询，可否使用mock？

是否该使用mock？在项目初期，为了能够更加快速的迭代，如此细粒度的测试，会严重拖慢项目进度。甚至一些人会因为工作繁重，没有精力进行测试。这种情况下，就没必要强求很高的测试覆盖率，而采用只对接口进行一些情况的测试。当代码进行重构的时候，保证接口可以按照预定的行为进行工作。更细一点，比如一个Handler，对他进行测试即可。完全的使用curl进行测试的方式，保证对系统外部来说，it works。细节上我们是怎么做的。我们的项目是GraphQl接口，对外只需要对外暴漏核心的几个url接口（3个），对web容器的依赖几乎没有，所以项目本身使用了Go的http，完全不需要第三方的web容器，因为go+http已经做的很好了。当重构的时候，项目结构定型之后，通过单元测试，保证了原来功能不变。这样可以保证功能正确的情况下，不需要话费很高的成本。

对于数据库是否使用mock？我们选择不使用mock，而是选择了单独配置测试用数据库的方式。这样测试时候数据库与生产数据完全隔离，而且测试数据库用完即删除，保证生产环境跑单元测试不会污染环境。由于docker的存在，甚至可以做成up新的docker，在docker中跑测试，测试通过即rm，这种解决方案也是可行的。

测试数据怎么办？对于一些测试数据，可以直接放到数据文件中，用的时候导入数据库，做到测试可重复。

## restfull vs GraphQL
restful接口的粒度太碎了，需要进行版本化管理。而对于Graphql来说，是不需要进行版本话处理的，经过简单设计的GraphQL接口即可通过model的演化，做到不需要版本话。

graphql的优点很明显，对于接口调用方，想要什么结构的数据，构造查询即可。
当然也有比较差的地方，N+1问题，所有需要的数据不经处理的进行查询。所有需要使用dataloader的方式，将查询打包成一批，一起进行查询后返回。借助多级缓存的方式，可以将查询成本降低到与restful相同。graphql可以做成中间层、兼容层，放到后端各种接口前端，向外部提供统一的接口。

## 缓存架构

## 关于技术选型
